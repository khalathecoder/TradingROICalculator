@page "/journal"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Microsoft.AspNetCore.Components.Forms
@using TradingROICalculator.Models

<h3 class="text-center mb-3">SurePath Trading – Journal</h3>

<div class="card p-4 mb-4">
    <div class="mb-3">
        <div class="fw-bold mb-1">Setup (optional)</div>
        <label class="me-3"><input type="radio" name="setup" value="Breakout" @onchange="e => _setup = e.Value?.ToString()" checked="@(_setup == "Failed 2u")" /> Breakout</label>
        <label class="me-3"><input type="radio" name="setup" value="Reversal" @onchange="e => _setup = e.Value?.ToString()" checked="@(_setup == "Failed 2d")" /> Reversal</label>
        <label class="me-3"><input type="radio" name="setup" value="Pullback" @onchange="e => _setup = e.Value?.ToString()" checked="@(_setup == "Pullback")" /> Pullback</label>
    </div>

    <div class="mb-3">
        <div class="fw-bold mb-1">Direction (optional)</div>
        <label class="me-3"><input type="radio" name="direction" value="Long" @onchange="e => _direction = e.Value?.ToString()" checked="@(_direction == "Long")" /> Long</label>
        <label class="me-3"><input type="radio" name="direction" value="Short" @onchange="e => _direction = e.Value?.ToString()" checked="@(_direction == "Short")" /> Short</label>
    </div>

    <div class="mb-3">
        <div class="fw-bold mb-1">Result (optional)</div>
        <label class="me-3"><input type="radio" name="result" value="Win" @onchange="e => _result = e.Value?.ToString()" checked="@(_result == "Win")" /> Win</label>
        <label class="me-3"><input type="radio" name="result" value="Loss" @onchange="e => _result = e.Value?.ToString()" checked="@(_result == "Loss")" /> Loss</label>
        <label class="me-3"><input type="radio" name="result" value="BE" @onchange="e => _result = e.Value?.ToString()" checked="@(_result == "BE")" /> BE</label>
    </div>

    <div class="mb-3">
        <label class="form-label fw-bold">Notes</label>
        <textarea class="form-control"
                  rows="10"
                  @bind="_notes"
                  @bind:event="oninput">
        </textarea>
    </div>

    <div class="mb-3">
        <label class="form-label fw-bold">Screenshot (optional)</label>
        <InputFile OnChange="HandleScreenshotUpload" accept="image/*" />
        <div class="form-text">Upload a TradingView screenshot for this entry.</div>
    </div>

    @if (!string.IsNullOrWhiteSpace(_screenshotDataUrl))
    {
        <div class="mb-3">
            <div class="fw-bold">Preview:</div>
            <img src="@_screenshotDataUrl"
                 style="max-width: 100%; border: 1px solid #ccc; border-radius: 6px;" />
            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" @onclick="ClearScreenshot">
                Remove screenshot
            </button>
        </div>
    }

    <button type="button" class="btn btn-primary" @onclick="AddEntry">
        Add Entry
    </button>
</div>

@if (_entries.Count > 0)
{
    <div class="list-group">
        @foreach (var e in _entries.OrderByDescending(x => x.CreatedUtc))
        {
            <div class="list-group-item mb-2">
                <small class="text-muted">@e.CreatedUtc.ToLocalTime().ToString("g")</small>

                @if (!string.IsNullOrWhiteSpace(e.Notes))
                {
                    <p class="mb-2">@e.Notes</p>
                }

                @if (!string.IsNullOrWhiteSpace(e.ScreenshotDataUrl))
                {
                    <img src="@e.ScreenshotDataUrl"
                         style="max-width: 100%; border: 1px solid #ccc; border-radius: 6px;" />
                }
            </div>
        }
    </div>
}
else
{
    <p class="text-muted">No journal entries yet. Add your first note above.</p>
}

@code {
    private string _notes = "";
    private string? _screenshotDataUrl;

    private readonly List<JournalEntry> _entries = new();

    private static readonly string[] AllowedImageTypes =
    {
        "image/png",
        "image/jpeg",
        "image/webp"
    };

    private string? _setup;
    private string? _direction;
    private string? _result;


    private const long MaxScreenshotBytes = 4 * 1024 * 1024; // 4 MB

    private async Task HandleScreenshotUpload(InputFileChangeEventArgs e)
    {
        _screenshotDataUrl = null;

        var file = e.File;
        if (file is null) return;

        // size limit
        if (file.Size > MaxScreenshotBytes) return;

        // type allowlist
        if (!AllowedImageTypes.Contains(file.ContentType)) return;

        using var stream = file.OpenReadStream(MaxScreenshotBytes);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);

        var bytes = ms.ToArray();
        _screenshotDataUrl = $"data:{file.ContentType};base64,{Convert.ToBase64String(bytes)}";
    }

    private void ClearScreenshot() => _screenshotDataUrl = null;

    private void AddEntry()
    {
        if (string.IsNullOrWhiteSpace(_notes) && string.IsNullOrWhiteSpace(_screenshotDataUrl))
            return;

        _entries.Add(new JournalEntry
        {
            CreatedUtc = DateTime.UtcNow,
            Notes = _notes.Trim(),
            ScreenshotDataUrl = _screenshotDataUrl,
            Setup = _setup,
            Direction = _direction,
            Result = _result,
            UserId = "local"
        });
    }

}
